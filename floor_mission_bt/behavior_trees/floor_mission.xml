<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="main_loop">

  <BehaviorTree ID="main_loop">

    <Sequence>

      <InitDroneVars drone_name="{drone_name}"/>

      <!-- One-time initialization -->
      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="250">
          <RegisterDrone drone_name="{drone_name}"/>
        </Delay>
      </RetryUntilSuccessful>

      <!-- Main loop, repeat forever -->
      <Repeat num_cycles = "-1">

        <Sequence>
          <!-- Keep checking if drone is idle w/ heartbeat, and triggered for a floor mission -->
          <RetryUntilSuccessful num_attempts="-1">
            <Delay delay_msec="1000">
              <Sequence>
                <CheckHeartbeat />
                <CheckIdle/> 
                <CheckIfFloorMissionTriggered
                  drone_name = "{drone_name}"
                  worker_name = "{worker_name}"
                  pickup_location_name = "{pickup_location_name}"
                  pickup_orientation = "{pickup_orientation}"
                  dropoff_location_name = "{dropoff_location_name}"
                  dropoff_orientation = "{dropoff_orientation}"
                  post_dropoff_location_name = "{post_dropoff_location_name}"
                />
              </Sequence>
            </Delay>
          </RetryUntilSuccessful>

          <!-- Execute the floor mission -->
          <SubTree ID="floor_mission" 
            drone_name = "{drone_name}"
            worker_name = "{worker_name}"
            pickup_location_name = "{pickup_location_name}"
            pickup_orientation = "{pickup_orientation}"
            dropoff_location_name = "{dropoff_location_name}"
            dropoff_orientation = "{dropoff_orientation}"
            post_dropoff_location_name = "{post_dropoff_location_name}"
          />

        </Sequence>
      </Repeat>
    </Sequence>
  </BehaviorTree>



  <BehaviorTree ID="floor_mission">

    <Sequence>

      <ClearLocalCostmap/>
      <ClearGlobalCostmap/>

      <GoToPlace 
        vertex_name="{pickup_location_name}" 
        orientation="{pickup_orientation}"
        drone_name="{drone_name}" 
      />

      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="250">
          <CheckGoToPlaceSuccess vertex_name="{pickup_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful>

      <SuspendRMFPathing/>
      <SendComeOutTrigger worker_name="{worker_name}"/>

      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="1000">                
          <CheckComeOutComplete worker_name="{worker_name}"/>
        </Delay>
      </RetryUntilSuccessful>

      <PickupWorker drone_name="{drone_name}" worker_name="{worker_name}" />
      <ClearLocalCostmap/>
      <ClearGlobalCostmap/>
      <UpdateFootprint is_carrying_worker="True"/>
      <SetLocalCostmapParams is_carrying_worker="True"/>
      <SetGlobalCostmapParams is_carrying_worker="True"/>
      <ReleaseRMFPathing/>


      <GoToPlace 
        vertex_name="{dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />
      
      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="250">
          <CheckGoToPlaceSuccess vertex_name="{dropoff_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful>

      <SendDropoffPosition drone_name="{drone_name}"/>

      <SuspendRMFPathing/>
      <LowerWorker drone_name="{drone_name}" worker_name="{worker_name}"/>
      <UpdateFootprint is_carrying_worker="False"/>
      <SetLocalCostmapParams is_carrying_worker="False"/>
      <SetGlobalCostmapParams is_carrying_worker="False"/>
      <UpdateFootprint is_carrying_worker="False"/>

      <ReleaseRMFPathing/>

      <GoToPlace 
        vertex_name="{post_dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />

      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="250">
          <CheckGoToPlaceSuccess vertex_name="{post_dropoff_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful>

      <ClearLocalCostmap/>
      <ClearGlobalCostmap/>

      <SendFloorMissionSuccess drone_name="{drone_name}"/>


    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="repeat_idle_check">

    <RetryUntilSuccessful num_attempts="-1">
      <Delay delay_msec="3000">
        <CheckIdle/> 
      </Delay>
    </RetryUntilSuccessful>

  </BehaviorTree>

</root>
