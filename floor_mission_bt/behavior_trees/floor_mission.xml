<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="main_loop">

  <BehaviorTree ID="main_loop">

    <Sequence>

      <!-- Variable initialization -->
      <InitDroneVars 
        drone_floor_mission_status="{drone_floor_mission_status}"
        drone_name="{drone_name}"
      />

      <!-- Main loop, repeat forever -->
      <Repeat num_cycles = "-1">

        <Sequence>

          
          <!-- Keep checking if drone is idle w/ heartbeat, and triggered for a floor mission -->
          
          <RetryUntilSuccessful num_attempts="-1">
            <Sequence>
              <SubTree ID="repeat_idle_check"/>

              <CheckIfSelectedForFloorMission
                drone_name = "{drone_name}"
                worker_name = "{worker_name}"
                pickup_location_name = "{pickup_location_name}"
                pickup_orientation = "{pickup_orientation}"
                dropoff_location_name = "{dropoff_location_name}"
                dropoff_orientation = "{dropoff_orientation}"
                post_dropoff_location_name = "{post_dropoff_location_name}"
                drone_floor_mission_status = "{drone_floor_mission_status}"
              />
            </Sequence>
          </RetryUntilSuccessful>


          <!-- Execute the floor mission -->
          <SubTree ID="floor_mission"/>

        </Sequence>
      </Repeat>
    </Sequence>
  </BehaviorTree>


  <!-- 
    Execute the main floor mission, consisting of:
    1. Go to pickup position
    2. Pickup the worker
    3. Bring worker to row start
    4. Lower Worker
    5. Back up out of the way

    Assumptions:
    1. floor_mission is started with an idle robot that has a healthy heartbeat and was triggered by the queen to do a floor mission
   -->
  <BehaviorTree ID="floor_mission">

    <Sequence>

      <!-- <SubTree ID="repeat_idle_check"/> -->
    
      <!-- <GoToPlace 
        vertex_name="{pickup_location_name}" 
        orientation="{pickup_orientation}"
        drone_name="{drone_name}" 
      /> -->

      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="1">
          <CheckGoToPlaceSuccess vertex_name="{pickup_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful>

      <!-- <SuspendRMFPathing/>
      <PickupWorker/>
      <ReleaseRMFPathing/> -->

      <!-- <SubTree ID="repeat_idle_check"/> -->

      <!-- <GoToPlace 
        vertex_name="{dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />
      
      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="1">
          <CheckGoToPlaceSuccess vertex_name="{dropoff_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful> -->

      <!-- <SuspendRMFPathing/>
      <LowerWorker/>
      <ReleaseRMFPathing/> -->

      <!-- <SubTree ID="repeat_idle_check"/> -->

      <!-- <GoToPlace 
        vertex_name="{post_dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />

      <RetryUntilSuccessful num_attempts="-1">
        <Delay delay_msec="1">
          <CheckGoToPlaceSuccess vertex_name="{post_dropoff_location_name}" error_state="{error_state}"/>
        </Delay>            
      </RetryUntilSuccessful> -->

      

    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="repeat_idle_check">

    <RetryUntilSuccessful num_attempts="-1">
      <Delay delay_msec="3">
        <Sequence>
          
          <CheckIdle/> 
        </Sequence>
      </Delay>
    </RetryUntilSuccessful>

  </BehaviorTree>

</root>
