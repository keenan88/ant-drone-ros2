<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="main_loop">

  <BehaviorTree ID="main_loop">

    <Sequence>

      <!-- Variable initialization -->
      <InitDroneVars 
        drone_floor_mission_status="{drone_floor_mission_status}"
        drone_name="{drone_name}"
      />

      <!-- Main loop, repeat forever -->
      <Repeat num_cycles = "-1">

        <Sequence>

          <RetryUntilSuccessful num_attempts="3">
            <Delay delay_msec="3">
              <Sequence>
                <CheckHeartbeat drone_floor_mission_status = "{drone_floor_mission_status}" error_state = "{error_state}"/>
              </Sequence>
            </Delay>
          </RetryUntilSuccessful>
          

          <!-- <SubTree ID="repeat_idle_check"/> -->

          <!-- Keep checking if the drone has been selected for a floor mission until it has -->
          <!-- <RetryUntilSuccessful num_attempts="-1">
            <Delay delay_msec="3">
              <Sequence>

                <CheckHeartbeat drone_floor_mission_status = "{drone_floor_mission_status}" error_state = "{error_state}"/>

                <CheckIfSelectedForFloorMission
                  drone_name = "{drone_name}"
                  worker_name = "{worker_name}"
                  pickup_location_name = "{pickup_location_name}"
                  pickup_orientation = "{pickup_orientation}"
                  dropoff_location_name = "{dropoff_location_name}"
                  dropoff_orientation = "{dropoff_orientation}"
                  post_dropoff_location_name = "{post_dropoff_location_name}"
                  drone_floor_mission_status = "{drone_floor_mission_status}"
                />
                
              </Sequence>
            </Delay>
          </RetryUntilSuccessful> -->

          <!-- Execute the floor mission -->
          <!-- <SubTree ID="floor_mission"/> -->

        </Sequence>
      </Repeat>
    </Sequence>
  </BehaviorTree>


  <!-- 
    Execute the main floor mission, consisting of:
    1. Go to pickup position
    2. Pickup the worker
    3. Bring worker to row start
    4. Lower Worker
    5. Back up out of the way
   -->
  <BehaviorTree ID="floor_mission">

    <Sequence>

      <SubTree ID="repeat_idle_check"/>
    
      <GoToPlace 
        vertex_name="{pickup_location_name}" 
        orientation="{pickup_orientation}"
        drone_name="{drone_name}" 
      />

      <SubTree ID="repeat_idle_check"/>


      <SuspendRMFPathing/>
      <PickupWorker/>
      <ReleaseRMFPathing/>

      <SubTree ID="repeat_idle_check"/>

      <GoToPlace 
        vertex_name="{dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />
      
      <SubTree ID="repeat_idle_check"/>

      <SuspendRMFPathing/>

      <LowerWorker/>

      <GoToPlace 
        vertex_name="{post_dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />

      <SubTree ID="repeat_idle_check"/>

      <ReleaseRMFPathing/>

    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="repeat_idle_check">

    <RetryUntilSuccessful num_attempts="-1">
      <Delay delay_msec="3">
        <Sequence>
          <CheckIdle/> 
          <CheckHeartbeat drone_floor_mission_status = "{drone_floor_mission_status}" error_state = "{error_state}"/>
        </Sequence>
      </Delay>
    </RetryUntilSuccessful>

  </BehaviorTree>

</root>
