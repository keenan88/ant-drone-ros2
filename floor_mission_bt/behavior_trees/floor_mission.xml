<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="main_loop">

  <BehaviorTree ID="main_loop">

    <Sequence>

      <InitDroneVars 
        floor_mission_state="{floor_mission_state}"
        drone_name="{drone_name}"
      />

      <ReactiveSequence>

        <SubTree ID="floor_mission"/>

      </ReactiveSequence>

    </Sequence>
  </BehaviorTree>


  <!-- 
    Execute the main floor mission, consisting of:
    1. Go to pickup position
    2. Pickup the worker
    3. Bring worker to row start
    4. Lower Worker
    5. Back up out of the way
   -->
  <BehaviorTree ID="floor_mission">

    <Sequence>

      <RetryUntilSuccessful num_attempts="-1">

        <CheckFloorMissionTriggered 
          worker_name="{worker_name}" 
          drone_name="{drone_name}" 
          pickup_location_name="{pickup_location_name}" 
          pickup_orientation="{pickup_orientation}"
          dropoff_location_name="{dropoff_location_name}" 
          dropoff_orientation="{dropoff_orientation}"
          post_dropoff_location_name="{post_dropoff_location_name}"
          floor_mission_state="{floor_mission_state}"
        />

      </RetryUntilSuccessful>



      <SubTree ID="repeat_idle_check"/>
    
      <GoToPlace 
        vertex_name="{pickup_location_name}" 
        orientation="{pickup_orientation}"
        drone_name="{drone_name}" 
      />

      <SubTree ID="repeat_idle_check"/>


      <SuspendRMFPathing/>
      <PickupWorker/>
      <ReleaseRMFPathing/>

      <GoToPlace 
        vertex_name="{dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />
      
      <SubTree ID="repeat_idle_check"/>

      <SuspendRMFPathing/>

      <LowerWorker/>

      <GoToPlace 
        vertex_name="{post_dropoff_location_name}" 
        orientation="{dropoff_orientation}"
        drone_name="{drone_name}" 
      />

      <SubTree ID="repeat_idle_check"/>

      <ReleaseRMFPathing/>

    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="repeat_idle_check">

    <!-- TODO - add method of checking if go to place method actually started getting executed. -->
    <RetryUntilSuccessful num_attempts="-1">
      <Delay delay_msec="5">
        <CheckIdle/>
      </Delay>
    </RetryUntilSuccessful>

  </BehaviorTree>

</root>
