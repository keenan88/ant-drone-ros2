# SLAM & Maps

# SLAM (map generation)

1. (first time only) Run `gitmodule init` from the repo root.
2. (first time only) Run `docker compose -f docker-compose.slam.yaml build`
3. Start Isaacsim simulation as detailed above. You do not need to start the teleop file.
4. Run `docker compose -f docker-compose.slam.yaml up`.
5. RVIZ2 will open a view of the robot, including its base frame, laser scans, and the map being generated.

![image](https://github.com/user-attachments/assets/9cd74e48-2e57-49d6-a1e9-6bf72832615f)

6. Drive the robot around with the teleop terminal or xbox controller.
7. The map will expand as the robot drives around. The robot should stay well-localized to the map, and the scans should stay aligned to the map.

![image](https://github.com/user-attachments/assets/aad7d61e-92ad-4c15-9a90-82a8ed1b8f70)

8. When you are happy with your map, run `docker exec -it linorobot2-slam bash` and `ros2 run nav2_map_server map_saver_cli -t /nav2/map -f /home/humble_ws/src/antdrone_navigation/maps/greenhouse`

9. Be sure the robot is in the map bounds or the map will not save.

10. You can view your map in the [map folder](/antdrone_navigation/maps/)  



## Map Cleanup

1. Install gimp: `apt install gimp`
2. Open gimp and open the .pgm map image file generated by nav2

![image](https://github.com/user-attachments/assets/29c1b3a7-fff2-427a-a17e-4ad77640a56c)


4. Remove any dynamic obstacles that should not be in the static costmap with the `Eraser Tool`.

![image](https://github.com/user-attachments/assets/99ea09cf-31ab-47cd-91a0-d3493cb7a703)

5. Select `Tools -> Transform tools -> Rotate`, and rotate the image until the pipe rail lengths look horizontal. Rotation will induce a blur.

![image](https://github.com/user-attachments/assets/1ed3dcb3-8f28-4c4d-81e8-2b742947e1cb)
_The edges of a rotated pipe rail should not slant from one row of pixels up or down, but be perfectly level._

7. Select `Image -> Canvas Size` and change the canvas to fit the rotated image.

![image](https://github.com/user-attachments/assets/d1e0ef54-adbd-407a-9984-4a9f8d6ecb36)
   
9. Select `Filters -> Enhance -> Sharpen`. Change the "Amount" parameter until the pipe rails show up black.

![image](https://github.com/user-attachments/assets/7f10b7c1-bdbf-4456-a169-a070bb039571)
_The edges of a rotated & sharpened pipe rail should not slant from one row of pixels up or down, but be perfectly level._

9. Use the `Pencil Tool` with white ink to remove any undesired dark pixels added in the sharpening.

![image](https://github.com/user-attachments/assets/e2a3d587-ec4e-4b31-a7a2-a6a5bf216daf)
    
11. Press `Ctrl + Shift + E` and export the new map to .pgm format (use default export settings).
12. Press `Ctrl + Shift + E` and export the new map to .png format, if you want to use it in RMF traffic editor (use default export settings).

## Adding keepout zones to map

1. Follow [this](https://docs.nav2.org/tutorials/docs/navigation2_with_keepout_filter.html) tutorial to create the .pgm and .yaml files that represent a keepout mask.
2. For compatbility with RMF traffic editor, set the map origin in the yaml file to `[0.0, y, 0.0]`, where `y = -1 * resolution * map height in px` (You can find map height in the .pgm file's properties).
   1. For example, if the image height was 300 pixels, and resolution 0.05m/px, replace y with -15, since -0.05 * 300 = -15.
3. Edit [filter_mask_server.yaml](/antdrone_navigation/config/filter_mask_server.yaml) -> `filter_mask_server -> yaml_filename` to point to the yaml file that lists your keepout filter .pgm image.
4. Run ___-compose.yaml. The keepout filter can be viewed in foxglove or rviz2.
